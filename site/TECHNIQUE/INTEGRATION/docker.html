<!DOCTYPE html>
<html class="writer-html5" lang="fr" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://www.uepal.fr/TECHNIQUE/INTEGRATION/docker.html" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Description générale - Documentation UEPAL Civiparoisse</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Description g\u00e9n\u00e9rale";
        var mkdocs_page_input_path = "TECHNIQUE/INTEGRATION/docker.md";
        var mkdocs_page_url = "/TECHNIQUE/INTEGRATION/docker.html";
      </script>
    
    <script src="../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../index.html">
          <img src="../../assets/uepal-logo.svg" class="logo" alt="Logo"/>
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../index.html">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Présentation</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../PRESENTATION/index.html">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../PRESENTATION/presentation_fonctionnelle.html">Périmètre fonctionnel</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../PRESENTATION/presentation_ecosysteme.html">Ecosystème projet</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../PRESENTATION/presentation_livrables.html">Livrables</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Technique</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../roles.html">Rôles</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Mail</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../MAIL/mail.html">Index</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../MAIL/ecosysteme.html">Ecosystème</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../MAIL/sendmail.html">Envoi</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../MAIL/fetchmail.html">Réception</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Logiciel</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../LOGICIEL/index.html">Index</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../LOGICIEL/distribution_code_composer.html">Distribution de code</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../LOGICIEL/environnement_dev.html">Environnement de dev</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../LOGICIEL/environnement_dev_env.html">Personnalisation environnement de dev</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../LOGICIEL/importation.html">Importation de données</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Intégration</a>
    <ul class="current">
                <li class="toctree-l2"><a class="reference internal" href="index.html">Index</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="etude_authentification.html">Authentification</a>
                </li>
                <li class="toctree-l2 current"><a class="reference internal current" href="#">Docker</a>
    <ul class="current">
                <li class="toctree-l3 current"><a class="reference internal current" href="docker.html">Description générale</a>
    <ul class="current">
    <li class="toctree-l4"><a class="reference internal" href="#liste-des-images">Liste des images</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#dependances-des-images-entre-elles">Dépendances des images entre elles</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#principe-de-fonctionnement">Principe de fonctionnement</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#gestion-des-droits-sur-les-fichiers">Gestion des droits sur les fichiers</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#volumes-principaux">Volumes principaux</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#docker-compose">Docker-compose</a>
    </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="#">Images</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="DOCKER/composer_base.html">Composer_base</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="DOCKER/composer_files.html">Composer_files</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="DOCKER/tools.html">tools</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="DOCKER/init.html">init</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="DOCKER/cron.html">cron</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="DOCKER/selfkeys.html">selfkeys</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="DOCKER/httpd.html">httpd</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="DOCKER/authenticator.html">authenticator</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="DOCKER/proxy.html">proxy</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="DOCKER/db_tls_server.html">db_tls_server</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="DOCKER/db_tls_client.html">db_tls_client</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="DOCKER/update.html">update</a>
                </li>
    </ul>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="db_ssl.html">DB_SSL</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="#">Kubernetes</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="KUBERNETES/maquettage.html">Maquettage</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="KUBERNETES/ressources.html">Ressources utiles</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="#">Chart Helm</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="KUBERNETES/HELM/description_generale.html">Description générale</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="KUBERNETES/HELM/db_dbproxy.html">DB et DB proxy</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="KUBERNETES/HELM/httpd.html">Serveur web interne</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="KUBERNETES/HELM/proxy_auth.html">Proxy et authenticateur</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="KUBERNETES/HELM/cron.html">Cron</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="KUBERNETES/HELM/volumes.html">Volumes (persistants)</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="KUBERNETES/HELM/secrets.html">Secrets</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="KUBERNETES/HELM/reservations.html">Réservations</a>
                </li>
    </ul>
                </li>
    </ul>
                </li>
    </ul>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Documentation UEPAL Civiparoisse</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html" class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>Technique &raquo;</li>
          <li>Intégration &raquo;</li>
          <li>Docker &raquo;</li>
      <li>Description générale</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="docker">Docker</h1>
<p>Docker permet de mettre en oeuvre une architecture microservices, avec des images spécialisées, adaptées aux environnements grâce par exemple à des variables d'environnement que l'on peut passer en argument de docker-run (par exemple).</p>
<p>Le but des images est d'être des images les plus stables possibles - idéalement des images que l'on pourrait utiliser en lecture seule. Les parties variables seraient idéalement toutes dans des volumes.</p>
<p>Chaque Dockerfile du projet dispose d'une directive <code>LABEL</code> directement après la directive <code>FROM</code> initiale, de sorte à pouvoir invalider simplement le cache en modifiant les valeurs des labels.</p>
<p>Un script de build des images ( <code>build.sh</code>) est fourni dans le dépôt.</p>
<h2 id="liste-des-images">Liste des images</h2>
<p>Un certain nombre d'images Docker est nécessaire pour exécuter un environnement Civiparoisse complet.</p>
<p>Ces images, dans l'ordre de build, sont :</p>
<ul>
<li><a href="DOCKER/composer_base.html">composer_base</a></li>
<li><a href="DOCKER/composer_files.html">composer_files</a></li>
<li><a href="DOCKER/tools.html">tools</a></li>
<li><a href="DOCKER/init.html">init</a></li>
<li><a href="DOCKER/cron.html">cron</a></li>
<li><a href="DOCKER/selfkeys.html">selfkeys</a></li>
<li><a href="DOCKER/httpd.html">httpd</a></li>
<li><a href="DOCKER/authenticator.html">authenticator</a></li>
<li><a href="DOCKER/proxy.html">proxy</a></li>
</ul>
<h2 id="dependances-des-images-entre-elles">Dépendances des images entre elles</h2>
<p>En se basant sur la directive FROM des Dockerfiles, on obtient les dépendances suivantes :</p>
<ul>
<li>ubuntu</li>
<li>authenticator</li>
<li>selfkeys</li>
<li>composer_base<ul>
<li>composer_files</li>
<li>tools<ul>
<li>cron</li>
<li>init</li>
</ul>
</li>
</ul>
</li>
<li>ubuntu/apache2</li>
<li>httpd</li>
<li>proxy</li>
<li>ubuntu/mysql             </li>
</ul>
<p>Toutefois, il y a également des injections de données d'une image à l'autre  via <code>COPY --from</code> :
* selfkeys
    * authenticator
    * httpd
    * proxy
* composer_files
    * httpd
    * tools
        * indirectement (cf from ): cron
        * indirectement (cf from ): init    </p>
<p>Le but de ces dépendances est de "stabiliser" le contenu des images buildées, pour que le contenu qui doit être présent dans plusieurs images soit identique.</p>
<h2 id="principe-de-fonctionnement">Principe de fonctionnement</h2>
<p>On suppose l'existence d'un <strong>forwarder TCP pricipal</strong> qui va faire l'aiguillage vers le bon reverse-proxy  de paroisse en se basant sur le Server Name Indication, qui apparaît en clair dans la connexion TLS. Il y a donc une connexion TLS entre le client et le serveur TLS, mais deux liaisons TCP (client/forwarder et forwarder/reverse proxy).</p>
<p>Le reverse proxy va authentifier les utilisateurs, au travers des identifiants Drupal convoyés via du HTTP Basic au-dessus d'une liason TLS, et probablement un autre moyen (certificat SSL par exemple). En ce qui concerne les identifiants, ils sont testé au travers d'un <strong>authenticateur</strong> qui est branché sur le reverse proxy au travers d'une socket Unix. Chaque requête adressée au reverse proxy doit être authentifiée, et déclenchera un appel à l'authenticateur.</p>
<p>L'authenticateur va effectuer une requête vers le <strong>serveur web interne</strong> pour vérifier que l'utilisateur est bien reconnu. Si tel est le cas, le reverse proxy va transférer la requête vers le serveur web interne pour être traitée.</p>
<h2 id="gestion-des-droits-sur-les-fichiers">Gestion des droits sur les fichiers</h2>
<p>La gestion des droits sur les fichiers est un sujet complexe. On suppose que les systèmes de fichiers mis en oeuvre dans le système proposent une gestion des droits traditionnels "à la Unix", avec des droits read-write-exec que l'on peut attribuer à un propriétaire, un groupe, et le reste du monde ; et on suppose qu'on peut identifier le propriétaire et le groupe de référence des fichiers.</p>
<p>Etant donné qu'en principe seul le propriétaire et root peuvent changer les permissions sur un fichier, et qu'il est préférable que le compte root ne soit pas trop utilisé (par exemple pour éviter par la suite une exécution en root via du bit SUID), il a été privilégié de créer un compte spécifique, verrouillé, dont le but est d'être propriétaire des fichiers : le compte paroisse (UID 1000). Un groupe paroisse (GID 1000) est également provisionné.</p>
<p>Le principe général est que les fichiers (pour l'instant, non système) qui sont présents dans les images sont des fichiers destinés à être en lecture seule, tandis que les fichiers des volumes seront en lecture écriture. Il s'agit d'appliquer le principe des droits minimaux pour effectuer les opérations.</p>
<p>L'idée est de donner aux fichiers le propriétaire paroisse, et le groupe www-data. De là, on peut positionner les droits sur les fichiers.</p>
<p>De même, il y a un compte authenticator (UID 1001) et un groupe authenticator (GID 1001) qui ont été crées sur l'image d'authenticateur. Compte également verrouillé.</p>
<p>En ce qui concerne les clefs, il faut se rappeler qu'Apache lit les clefs en tant que l'utilisateur lancé (root) avant de descendre ses droits. Du coup, les clefs n'ont pas besoin d'être lues par www-data.</p>
<h2 id="volumes-principaux">Volumes principaux</h2>
<p>Ces volumes sont :</p>
<ul>
<li>civicomp_dbvol: le volume de base de données</li>
<li>civicomp_filevol: le volume des fichiers, avec les fichiers spécifiques à l'instance courante</li>
<li>civicomp_privatevol : le volume des fichiers privés</li>
</ul>
<p>Les volumes sont montés avec l'option <code>nocopy: true</code> car ce fonctionnement correspond au fonctionnement en environnement Kubernetes. En environnement Kubernetes, il y aura des montages supplémentaires (les secrets et les variables d'environnement, par exemple).</p>
<h2 id="docker-compose">Docker-compose</h2>
<p>Deux docker-compose sont disponibles. L'un d'eux, <code>docker-init.yml</code> est prévu pour initialiser les volumes, tandis que l'autre (<code>docker-compose.yml</code>, nom par défaut) est utilisé pour l'exécution classique.</p>
<p>L'intérêt du docuker-compose réside dans le fait que docker-compose va s'occuper de faire les liaisons nécessaires entre les containers et les volumes, sans avoir besoin de saisir des lignes de commande fastidieuses. C'est donc un système analogue à ce qu'on retrouve dans la déclaration d'objets dans Kubernetes.</p>
<h3 id="initialisation-des-volumes">Initialisation des volumes</h3>
<p>On suppose qu'on se trouve dans le répertoire contenant les fichiers compose.</p>
<pre><code class="language-sh">docker-compose -f docker-init.yml up
docker-compose -f docker-init.yml rm
</code></pre>
<h3 id="utilisation-de-lenvironnement-docker-au-quotidien">Utilisation de l'environnement Docker au quotidien</h3>
<p>Il faut penser à mettre à jour son <code>/etc/hosts</code> pour disposer de la résolution de noms nécessaire. 
Ensuite, on peut faire des opérations quotidiennes avec des commandes comme, par exemple (en étant dans le répertoire contenant les fichiers compose) :</p>
<pre><code class="language-bash">docker-compose -d up
# [on fait le travail]
docker-compose stop
</code></pre>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="etude_authentification.html" class="btn btn-neutral float-left" title="Authentification"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="DOCKER/composer_base.html" class="btn btn-neutral float-right" title="Composer_base">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="etude_authentification.html" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="DOCKER/composer_base.html" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
